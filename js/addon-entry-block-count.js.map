{"version":3,"file":"js/addon-entry-block-count.js","sources":["webpack://GUI/./src/addons/addons/block-count/_runtime_entry.js","webpack://GUI/./src/addons/addons/block-count/blockcount.js"],"sourcesContent":["/* generated by pull.js */\nimport _js from \"./blockcount.js\";\nexport const resources = {\n  \"blockcount.js\": _js,\n};\n","export default async function ({ addon, console, msg }) {\n  const vm = addon.tab.traps.vm;\n\n  // Map opcode prefix to category\n  const getCategoryFromOpcode = (opcode) => {\n    if (!opcode) return null;\n\n    // Standard Scratch categories\n    if (opcode.startsWith('motion_')) return 'motion';\n    if (opcode.startsWith('looks_')) return 'looks';\n    if (opcode.startsWith('sound_')) return 'sound';\n    if (opcode.startsWith('event_')) return 'event';\n    if (opcode.startsWith('control_')) return 'control';\n    if (opcode.startsWith('sensing_')) return 'sensing';\n    if (opcode.startsWith('operator_')) return 'operators';\n    if (opcode.startsWith('data_')) return 'data';\n    if (opcode.startsWith('procedures_')) return 'procedures';\n    if (opcode.startsWith('argument_')) return 'procedures'; // Custom block arguments\n\n    // Extension blocks - extract extension name from opcode\n    // Format is usually: extensionName_blockName\n    const parts = opcode.split('_');\n    if (parts.length > 1) {\n      return `ext_${parts[0]}`; // e.g., \"ext_pen\", \"ext_music\"\n    }\n\n    return null;\n  };\n\n  const getBlockCount = () => {\n    let blockCount = 0;\n    let scriptCount = 0;\n    const categories = {};\n\n    let sprites = new Set(vm.runtime.targets.map((i) => i.sprite.blocks._blocks));\n    sprites.forEach((sprite, i) => {\n      Object.values(sprite).forEach((block) => {\n        if (!block.shadow) {\n          blockCount++;\n\n          // Count by category\n          const category = getCategoryFromOpcode(block.opcode);\n          if (category) {\n            categories[category] = (categories[category] || 0) + 1;\n          }\n        }\n\n        // Count scripts (top-level blocks)\n        if (!block.parent && !block.shadow) {\n          scriptCount++;\n        }\n      });\n    });\n\n    return {\n      blockCount,\n      scriptCount,\n      spriteCount: sprites.size - 1, // Backdrop counts as a target so we can subtract it\n      categories\n    };\n  };\n\n  // Get localized category name\n  const getCategoryName = (categoryKey) => {\n    const categoryNames = {\n      motion: msg('category-motion'),\n      looks: msg('category-looks'),\n      sound: msg('category-sound'),\n      event: msg('category-event'),\n      control: msg('category-control'),\n      sensing: msg('category-sensing'),\n      operators: msg('category-operators'),\n      data: msg('category-data'),\n      procedures: msg('category-procedures')\n    };\n\n    // For standard categories, use localized name\n    if (categoryNames[categoryKey]) {\n      return categoryNames[categoryKey];\n    }\n\n    // For extensions, extract the extension name\n    if (categoryKey.startsWith('ext_')) {\n      const extName = categoryKey.substring(4); // Remove 'ext_' prefix\n      // Try to get the extension's display name from Scratch\n      // For now, just capitalize the extension name\n      return extName.charAt(0).toUpperCase() + extName.slice(1);\n    }\n\n    return categoryKey;\n  };\n\n  const addLiveBlockCount = async () => {\n    if (vm.editingTarget) {\n      let handler = null;\n      let isExpanded = false; // Track expansion state\n\n      while (true) {\n        const topBar = await addon.tab.waitForElement(\"[class^='menu-bar_main-menu']\", {\n          markAsSeen: true,\n          reduxEvents: [\n            \"scratch-gui/mode/SET_PLAYER\",\n            \"fontsLoaded/SET_FONTS_LOADED\",\n            \"scratch-gui/locales/SELECT_LOCALE\",\n          ],\n          reduxCondition: (state) => !state.scratchGui.mode.isPlayerOnly,\n        });\n\n        // Create container for block count display\n        let container = topBar.appendChild(document.createElement(\"div\"));\n        addon.tab.displayNoneWhileDisabled(container);\n        container.style.order = 1;\n        container.style.display = \"flex\";\n        container.style.alignItems = \"center\";\n        container.style.gap = \"8px\";\n        container.style.marginLeft = \"8px\";\n\n        // Create main display (total count + arrow)\n        let mainDisplay = container.appendChild(document.createElement(\"span\"));\n        mainDisplay.style.display = \"flex\";\n        mainDisplay.style.alignItems = \"center\";\n        mainDisplay.style.gap = \"4px\";\n        mainDisplay.style.cursor = \"pointer\";\n        mainDisplay.style.userSelect = \"none\";\n\n        // Total count text\n        let countText = mainDisplay.appendChild(document.createElement(\"span\"));\n        countText.innerText = msg(\"blocks\", { num: getBlockCount().blockCount });\n\n        // Arrow button\n        let arrow = mainDisplay.appendChild(document.createElement(\"span\"));\n        arrow.innerText = \"â–¶\";\n        arrow.style.fontSize = \"10px\";\n        arrow.style.transition = \"transform 0.2s\";\n        arrow.style.display = \"inline-block\";\n\n        // Category details panel (initially hidden) - styled as dropdown\n        let detailsPanel = container.appendChild(document.createElement(\"div\"));\n        detailsPanel.style.display = \"none\";\n        detailsPanel.style.position = \"absolute\";\n        detailsPanel.style.top = \"calc(100% + 4px)\";\n        detailsPanel.style.left = \"0\";\n        detailsPanel.style.backgroundColor = \"white\";\n        detailsPanel.style.border = \"1px solid #d9d9d9\";\n        detailsPanel.style.borderRadius = \"4px\";\n        detailsPanel.style.boxShadow = \"0 2px 8px rgba(0, 0, 0, 0.15)\";\n        detailsPanel.style.padding = \"8px\";\n        detailsPanel.style.minWidth = \"180px\";\n        detailsPanel.style.zIndex = \"1000\";\n        detailsPanel.style.fontSize = \"12px\";\n\n        // Make container position relative for absolute positioning of dropdown\n        container.style.position = \"relative\";\n\n        // Update display function\n        const updateDisplay = () => {\n          const counts = getBlockCount();\n          countText.innerText = msg(\"blocks\", { num: counts.blockCount });\n\n          // Clear and rebuild details panel\n          detailsPanel.innerHTML = \"\";\n\n          // Standard categories in fixed order (always show these)\n          const standardCategories = [\n            'motion', 'looks', 'sound', 'event',\n            'control', 'sensing', 'operators', 'data', 'procedures'\n          ];\n\n          // Collect extension categories\n          const extensionCategories = Object.keys(counts.categories)\n            .filter(cat => cat.startsWith('ext_'))\n            .sort();\n\n          // Display standard categories first\n          standardCategories.forEach(category => {\n            const count = counts.categories[category] || 0;\n            const item = detailsPanel.appendChild(document.createElement(\"div\"));\n            item.style.padding = \"4px 8px\";\n            item.style.display = \"flex\";\n            item.style.justifyContent = \"space-between\";\n            item.style.gap = \"12px\";\n            item.style.borderRadius = \"2px\";\n            item.style.transition = \"background-color 0.1s\";\n\n            // Hover effect\n            item.addEventListener(\"mouseenter\", () => {\n              item.style.backgroundColor = \"#f0f0f0\";\n            });\n            item.addEventListener(\"mouseleave\", () => {\n              item.style.backgroundColor = \"transparent\";\n            });\n\n            const nameSpan = item.appendChild(document.createElement(\"span\"));\n            nameSpan.innerText = getCategoryName(category);\n            nameSpan.style.color = count > 0 ? \"#575e75\" : \"#999\";\n\n            const countSpan = item.appendChild(document.createElement(\"span\"));\n            countSpan.innerText = count.toString();\n            countSpan.style.fontWeight = \"bold\";\n            countSpan.style.color = count > 0 ? \"#4c97ff\" : \"#ccc\";\n          });\n\n          // Add separator if there are extensions\n          if (extensionCategories.length > 0) {\n            const separator = detailsPanel.appendChild(document.createElement(\"div\"));\n            separator.style.height = \"1px\";\n            separator.style.backgroundColor = \"#e0e0e0\";\n            separator.style.margin = \"4px 0\";\n          }\n\n          // Display extensions\n          extensionCategories.forEach(category => {\n            const count = counts.categories[category] || 0;\n            if (count > 0) {\n              const item = detailsPanel.appendChild(document.createElement(\"div\"));\n              item.style.padding = \"4px 8px\";\n              item.style.display = \"flex\";\n              item.style.justifyContent = \"space-between\";\n              item.style.gap = \"12px\";\n              item.style.borderRadius = \"2px\";\n              item.style.transition = \"background-color 0.1s\";\n\n              // Hover effect\n              item.addEventListener(\"mouseenter\", () => {\n                item.style.backgroundColor = \"#f0f0f0\";\n              });\n              item.addEventListener(\"mouseleave\", () => {\n                item.style.backgroundColor = \"transparent\";\n              });\n\n              const nameSpan = item.appendChild(document.createElement(\"span\"));\n              nameSpan.innerText = getCategoryName(category);\n              nameSpan.style.color = \"#575e75\";\n\n              const countSpan = item.appendChild(document.createElement(\"span\"));\n              countSpan.innerText = count.toString();\n              countSpan.style.fontWeight = \"bold\";\n              countSpan.style.color = \"#0fbd8c\";\n            }\n          });\n        };\n\n        // Toggle expansion\n        const toggleExpansion = () => {\n          isExpanded = !isExpanded;\n\n          if (isExpanded) {\n            arrow.style.transform = \"rotate(90deg)\";\n            detailsPanel.style.display = \"block\";\n            updateDisplay();\n          } else {\n            arrow.style.transform = \"rotate(0deg)\";\n            detailsPanel.style.display = \"none\";\n          }\n        };\n\n        // Click handler\n        mainDisplay.addEventListener(\"click\", toggleExpansion);\n\n        // Close dropdown when clicking outside\n        document.addEventListener(\"click\", (e) => {\n          if (!container.contains(e.target) && isExpanded) {\n            toggleExpansion();\n          }\n        });\n\n        // Initial display\n        updateDisplay();\n\n        // Debounced update on project changes\n        let debounce;\n        if (handler) {\n          vm.off(\"PROJECT_CHANGED\", handler);\n          vm.runtime.off(\"PROJECT_LOADED\", handler);\n        }\n\n        handler = async () => {\n          clearTimeout(debounce);\n          debounce = setTimeout(async () => {\n            updateDisplay();\n          }, 1000);\n        };\n\n        vm.on(\"PROJECT_CHANGED\", handler);\n        vm.runtime.on(\"PROJECT_LOADED\", handler);\n      }\n    } else {\n      let timeout = setTimeout(function () {\n        addLiveBlockCount();\n        clearTimeout(timeout);\n      }, 1000);\n    }\n  };\n\n  addLiveBlockCount();\n}\n"],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;A","sourceRoot":""}